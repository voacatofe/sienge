-- ============================================
-- EXEMPLO PR√ÅTICO: VIEW MATERIALIZADA PARA LOOKER STUDIO
-- Dashboard Comercial - Sienge Analytics
-- ============================================

-- üéØ OBJETIVO:
-- Criar uma view "larga" otimizada para o Looker Studio
-- com todas as dimens√µes e m√©tricas organizadas por categorias

-- üìä RPT_VENDAS_WIDE - Dashboard Comercial Completo
DROP MATERIALIZED VIEW IF EXISTS rpt_vendas_wide;

CREATE MATERIALIZED VIEW rpt_vendas_wide AS
SELECT
  -- =====================================
  -- üìÖ DIMENS√ïES DE TEMPO
  -- =====================================
  cv.contractDate::date                           AS data_contrato,
  EXTRACT(YEAR FROM cv.contractDate)              AS ano,
  EXTRACT(QUARTER FROM cv.contractDate)           AS trimestre,
  EXTRACT(MONTH FROM cv.contractDate)             AS mes,
  TO_CHAR(cv.contractDate, 'YYYY-MM')            AS ano_mes,
  TO_CHAR(cv.contractDate, 'Month')               AS nome_mes,
  EXTRACT(DOW FROM cv.contractDate)               AS dia_semana,
  TO_CHAR(cv.contractDate, 'Day')                 AS nome_dia,

  -- =====================================
  -- üè¢ DIMENS√ïES DE EMPRESA
  -- =====================================
  emp.nomeEmpresa                                 AS empresa_nome,
  emp.cidade                                      AS empresa_cidade,
  emp.estado                                      AS empresa_estado,
  CASE
    WHEN emp.estado IN ('SP', 'RJ', 'MG', 'ES') THEN 'Sudeste'
    WHEN emp.estado IN ('PR', 'SC', 'RS') THEN 'Sul'
    WHEN emp.estado IN ('GO', 'MT', 'MS', 'DF') THEN 'Centro-Oeste'
    WHEN emp.estado IN ('BA', 'SE', 'AL', 'PE', 'PB', 'RN', 'CE', 'PI', 'MA') THEN 'Nordeste'
    WHEN emp.estado IN ('AC', 'AP', 'AM', 'PA', 'RO', 'RR', 'TO') THEN 'Norte'
    ELSE 'Outros'
  END                                             AS empresa_regiao,

  -- =====================================
  -- üë§ DIMENS√ïES DE CLIENTE
  -- =====================================
  cli.nomeCompleto                                AS cliente_nome,
  cli.personType                                  AS cliente_tipo_pessoa,
  cli.sex                                         AS cliente_sexo,
  cli.estadoCivilStr                              AS cliente_estado_civil,
  CASE
    WHEN cli.dataNascimento IS NULL THEN 'N√£o informado'
    WHEN EXTRACT(YEAR FROM AGE(cli.dataNascimento)) BETWEEN 18 AND 25 THEN '18-25'
    WHEN EXTRACT(YEAR FROM AGE(cli.dataNascimento)) BETWEEN 26 AND 35 THEN '26-35'
    WHEN EXTRACT(YEAR FROM AGE(cli.dataNascimento)) BETWEEN 36 AND 45 THEN '36-45'
    WHEN EXTRACT(YEAR FROM AGE(cli.dataNascimento)) BETWEEN 46 AND 55 THEN '46-55'
    WHEN EXTRACT(YEAR FROM AGE(cli.dataNascimento)) >= 56 THEN '56+'
    ELSE 'N√£o informado'
  END                                             AS cliente_faixa_etaria,

  -- =====================================
  -- üèóÔ∏è DIMENS√ïES DE EMPREENDIMENTO
  -- =====================================
  empr.nome                                       AS empreendimento_nome,
  empr.nomeComercial                             AS empreendimento_nome_comercial,
  empr.tipo                                       AS empreendimento_tipo,
  COALESCE(empr.nomeEmpresa, emp.nomeEmpresa)    AS empreendimento_empresa,

  -- =====================================
  -- üè† DIMENS√ïES DE UNIDADE
  -- =====================================
  uni.nome                                        AS unidade_nome,
  uni.tipoImovel                                  AS unidade_tipo,
  CASE
    WHEN uni.areaPrivativa < 50 THEN 'At√© 50m¬≤'
    WHEN uni.areaPrivativa BETWEEN 50 AND 100 THEN '50-100m¬≤'
    WHEN uni.areaPrivativa BETWEEN 100 AND 150 THEN '100-150m¬≤'
    WHEN uni.areaPrivativa > 150 THEN 'Acima 150m¬≤'
    ELSE 'N√£o informado'
  END                                             AS unidade_faixa_area,
  uni.areaPrivativa                               AS unidade_area_privativa,
  uni.pavimento                                   AS unidade_pavimento,

  -- =====================================
  -- üìä PERFORMANCE - Valores e Volumes
  -- =====================================
  cv.value                                        AS "Performance ‚Äî Valor Contrato",
  cv.totalSellingValue                           AS "Performance ‚Äî Valor Venda Total",

  -- Calcular valor por m¬≤ se √°rea dispon√≠vel
  CASE
    WHEN uni.areaPrivativa > 0 THEN ROUND(cv.value / uni.areaPrivativa, 2)
    ELSE NULL
  END                                             AS "Performance ‚Äî Valor por M¬≤",

  -- Margem (simplificada - pode ser refinada com dados de custo)
  CASE
    WHEN cv.totalSellingValue > 0
    THEN ROUND(((cv.totalSellingValue - cv.value) / cv.totalSellingValue * 100), 2)
    ELSE NULL
  END                                             AS "Performance ‚Äî Margem Bruta (%)",

  -- =====================================
  -- üí∞ CONVERSIONS - Status e Resultados
  -- =====================================
  cv.situation                                    AS "Conversions ‚Äî Status Contrato",

  -- Flags de convers√£o
  CASE WHEN cv.situation = 'Ativo' THEN 1 ELSE 0 END AS "Conversions ‚Äî Contratos Ativos",
  CASE WHEN cv.situation = 'Cancelado' THEN 1 ELSE 0 END AS "Conversions ‚Äî Contratos Cancelados",
  CASE WHEN cv.keysDeliveredAt IS NOT NULL THEN 1 ELSE 0 END AS "Conversions ‚Äî Chaves Entregues",

  -- Tempo de venda (dias desde lan√ßamento do empreendimento at√© contrato)
  CASE
    WHEN empr.dataCadastro IS NOT NULL AND cv.contractDate IS NOT NULL
    THEN EXTRACT(DAY FROM cv.contractDate - empr.dataCadastro)
    ELSE NULL
  END                                             AS "Conversions ‚Äî Tempo Venda (dias)",

  -- =====================================
  -- üí≥ FINANCIAL - Aspectos Financeiros
  -- =====================================
  cv.discountPercentage                          AS "Financial ‚Äî Desconto (%)",
  cv.discountPercentage * cv.value / 100         AS "Financial ‚Äî Valor Desconto",

  -- Forma de pagamento (derivada de campos existentes)
  CASE
    WHEN cv.interestType IS NOT NULL THEN 'Financiado'
    WHEN cv.value = cv.totalSellingValue THEN '√Ä Vista'
    ELSE 'Misto'
  END                                             AS "Financial ‚Äî Forma Pagamento",

  cv.interestPercentage                          AS "Financial ‚Äî Taxa Juros (%)",
  cv.fineRate                                    AS "Financial ‚Äî Taxa Multa (%)",

  -- =====================================
  -- üéØ SEGMENTA√á√ÉO E AN√ÅLISE
  -- =====================================

  -- Segmenta√ß√£o por valor
  CASE
    WHEN cv.value < 200000 THEN 'Econ√¥mico'
    WHEN cv.value BETWEEN 200000 AND 500000 THEN 'M√©dio'
    WHEN cv.value BETWEEN 500000 AND 1000000 THEN 'M√©dio-Alto'
    WHEN cv.value > 1000000 THEN 'Alto Padr√£o'
    ELSE 'N√£o classificado'
  END                                             AS "Segmentation ‚Äî Faixa Valor",

  -- Canal de venda (pode ser expandido com dados reais)
  CASE
    WHEN cv.salesRepresentative IS NOT NULL THEN 'Corretor'
    ELSE 'Direto'
  END                                             AS "Segmentation ‚Äî Canal Venda",

  -- =====================================
  -- üî¢ IDs T√âCNICOS (para drill-through)
  -- =====================================
  cv.id                                           AS contrato_id,
  cv.companyId                                    AS empresa_id,
  cv.enterpriseId                                 AS empreendimento_id,
  cli.idCliente                                   AS cliente_id

FROM contratos_venda cv
-- JOINs com as tabelas relacionadas
LEFT JOIN empresas emp ON emp.idEmpresa = cv.companyId
LEFT JOIN clientes cli ON cli.idCliente = ANY(
  SELECT jsonb_array_elements_text(cv.salesContractCustomers::jsonb -> 'customers')::int
  UNION
  SELECT (cv.salesContractCustomers->>'customerId')::int WHERE cv.salesContractCustomers->>'customerId' IS NOT NULL
)
LEFT JOIN empreendimentos empr ON empr.id = cv.enterpriseId
LEFT JOIN unidades uni ON uni.idContrato = cv.id

-- Filtros b√°sicos
WHERE cv.contractDate IS NOT NULL
  AND cv.value > 0;

-- =====================================
-- üöÄ √çNDICES PARA PERFORMANCE
-- =====================================
CREATE INDEX ON rpt_vendas_wide (data_contrato);
CREATE INDEX ON rpt_vendas_wide (ano, mes);
CREATE INDEX ON rpt_vendas_wide (empresa_regiao, empresa_estado);
CREATE INDEX ON rpt_vendas_wide (empreendimento_nome);
CREATE INDEX ON rpt_vendas_wide ("Conversions ‚Äî Status Contrato");
CREATE INDEX ON rpt_vendas_wide ("Performance ‚Äî Valor Contrato");

-- =====================================
-- üìù COMENT√ÅRIOS E METADADOS
-- =====================================
COMMENT ON MATERIALIZED VIEW rpt_vendas_wide IS
'View materializada otimizada para Looker Studio - Dashboard Comercial
Atualiza√ß√£o: Di√°ria √†s 6h
Gr√£o: Contrato de Venda
M√©tricas organizadas por categorias: Performance, Conversions, Financial, Segmentation';

-- =====================================
-- üîÑ SCRIPT DE REFRESH (para agendamento)
-- =====================================
-- Para executar diariamente:
-- REFRESH MATERIALIZED VIEW CONCURRENTLY rpt_vendas_wide;


-- =====================================
-- üìä EXEMPLO DE QUERY PARA LOOKER STUDIO
-- =====================================
/*
-- No Looker Studio, usar Custom Query:

SELECT * FROM rpt_vendas_wide
WHERE data_contrato BETWEEN @DS_START_DATE AND @DS_END_DATE
ORDER BY data_contrato DESC;

-- O Looker Studio automaticamente aplicar√°:
-- - Filtros de data via @DS_START_DATE e @DS_END_DATE
-- - Agrega√ß√µes baseadas nas dimens√µes selecionadas
-- - Cache inteligente para performance
*/

-- =====================================
-- üé® ORGANIZA√á√ÉO NO LOOKER STUDIO
-- =====================================
/*
üìä Campos organizados por prefixo aparecem agrupados:

Performance
‚îú‚îÄ‚îÄ Performance ‚Äî Valor Contrato
‚îú‚îÄ‚îÄ Performance ‚Äî Valor Venda Total
‚îú‚îÄ‚îÄ Performance ‚Äî Valor por M¬≤
‚îî‚îÄ‚îÄ Performance ‚Äî Margem Bruta (%)

üí∞ Conversions
‚îú‚îÄ‚îÄ Conversions ‚Äî Status Contrato
‚îú‚îÄ‚îÄ Conversions ‚Äî Contratos Ativos
‚îú‚îÄ‚îÄ Conversions ‚Äî Contratos Cancelados
‚îú‚îÄ‚îÄ Conversions ‚Äî Chaves Entregues
‚îî‚îÄ‚îÄ Conversions ‚Äî Tempo Venda (dias)

üí≥ Financial
‚îú‚îÄ‚îÄ Financial ‚Äî Desconto (%)
‚îú‚îÄ‚îÄ Financial ‚Äî Valor Desconto
‚îú‚îÄ‚îÄ Financial ‚Äî Forma Pagamento
‚îú‚îÄ‚îÄ Financial ‚Äî Taxa Juros (%)
‚îî‚îÄ‚îÄ Financial ‚Äî Taxa Multa (%)

üéØ Segmentation
‚îú‚îÄ‚îÄ Segmentation ‚Äî Faixa Valor
‚îî‚îÄ‚îÄ Segmentation ‚Äî Canal Venda
*/