-- 06_create_functions.sql
-- Cria todas as funções customizadas no schema bronze
-- Este script é executado durante a inicialização do Docker

-- Log de início
DO $$
BEGIN
    RAISE NOTICE 'Criando funções customizadas em %', now();
END $$;

-- ===================================================================
-- FUNÇÕES CUSTOMIZADAS DO SCHEMA BRONZE
-- ===================================================================


                                                                                                                               ?column?                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION bronze.analyze_index_usage()                                                                                                                                                                                                              +
  RETURNS TABLE(schema_name text, table_name text, index_name text, table_size_mb numeric, index_size_mb numeric, index_scans bigint, tuples_read bigint, tuples_fetched bigint, efficiency_ratio numeric, recommendation text)                                       +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 BEGIN\r                                                                                                                                                                                                                                                              +
     RETURN QUERY\r                                                                                                                                                                                                                                                   +
     SELECT\r                                                                                                                                                                                                                                                         +
         schemaname::TEXT,\r                                                                                                                                                                                                                                          +
         relname::TEXT,\r                                                                                                                                                                                                                                             +
         indexrelname::TEXT,\r                                                                                                                                                                                                                                        +
         ROUND(pg_total_relation_size(relid) / (1024.0 * 1024.0), 2) as table_size_mb,\r                                                                                                                                                                              +
         ROUND(pg_total_relation_size(indexrelid) / (1024.0 * 1024.0), 2) as index_size_mb,\r                                                                                                                                                                         +
         idx_scan,\r                                                                                                                                                                                                                                                  +
         idx_tup_read,\r                                                                                                                                                                                                                                              +
         idx_tup_fetch,\r                                                                                                                                                                                                                                             +
         CASE\r                                                                                                                                                                                                                                                       +
             WHEN idx_scan = 0 OR idx_tup_read = 0 THEN 0\r                                                                                                                                                                                                           +
             ELSE ROUND((idx_tup_fetch::NUMERIC / NULLIF(idx_tup_read, 0)::NUMERIC) * 100, 2)\r                                                                                                                                                                       +
         END as efficiency_ratio,\r                                                                                                                                                                                                                                   +
         CASE\r                                                                                                                                                                                                                                                       +
             WHEN idx_scan = 0 THEN 'ÍNDICE NUNCA USADO - Considere remover'\r                                                                                                                                                                                        +
             WHEN idx_scan < 10 THEN 'BAIXO USO - Monitore por mais tempo'\r                                                                                                                                                                                          +
             WHEN (idx_tup_fetch::NUMERIC / NULLIF(idx_tup_read, 0)::NUMERIC) < 0.1 THEN 'BAIXA EFICIÊNCIA - Revisar'\r                                                                                                                                               +
             ELSE 'BOM DESEMPENHO'\r                                                                                                                                                                                                                                  +
         END as recommendation\r                                                                                                                                                                                                                                      +
     FROM pg_stat_user_indexes\r                                                                                                                                                                                                                                      +
     WHERE schemaname IN ('bronze', 'silver', 'gold', 'system')\r                                                                                                                                                                                                     +
     ORDER BY idx_scan DESC, table_size_mb DESC;\r                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.backup_full_datawarehouse(backup_path text DEFAULT '/tmp/backup'::text)                                                                                                                                                            +
  RETURNS text                                                                                                                                                                                                                                                        +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     result TEXT := '';\r                                                                                                                                                                                                                                             +
     schema_result TEXT;\r                                                                                                                                                                                                                                            +
     backup_date TEXT;\r                                                                                                                                                                                                                                              +
 BEGIN\r                                                                                                                                                                                                                                                              +
     backup_date := TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM-DD_HH24-MI-SS');\r                                                                                                                                                                                            +
 \r                                                                                                                                                                                                                                                                   +
     result := format(\r                                                                                                                                                                                                                                              +
         'BACKUP COMPLETO DO DATA WAREHOUSE - %s%s' ||\r                                                                                                                                                                                                              +
         '======================================================================%s%s',\r                                                                                                                                                                              +
         backup_date, E'\n',\r                                                                                                                                                                                                                                        +
         E'\n', E'\n'\r                                                                                                                                                                                                                                               +
     );\r                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     -- Backup do schema BRONZE\r                                                                                                                                                                                                                                     +
     SELECT backup_schema('bronze', backup_path) INTO schema_result;\r                                                                                                                                                                                                +
     result := result || 'BRONZE SCHEMA:' || E'\n' || schema_result || E'\n';\r                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                   +
     -- Backup do schema SILVER\r                                                                                                                                                                                                                                     +
     SELECT backup_schema('silver', backup_path) INTO schema_result;\r                                                                                                                                                                                                +
     result := result || 'SILVER SCHEMA:' || E'\n' || schema_result || E'\n';\r                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                   +
     -- Backup do schema GOLD\r                                                                                                                                                                                                                                       +
     SELECT backup_schema('gold', backup_path) INTO schema_result;\r                                                                                                                                                                                                  +
     result := result || 'GOLD SCHEMA:' || E'\n' || schema_result || E'\n';\r                                                                                                                                                                                         +
 \r                                                                                                                                                                                                                                                                   +
     -- Backup do schema SYSTEM\r                                                                                                                                                                                                                                     +
     SELECT backup_schema('system', backup_path) INTO schema_result;\r                                                                                                                                                                                                +
     result := result || 'SYSTEM SCHEMA:' || E'\n' || schema_result || E'\n';\r                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                   +
     result := result || format(\r                                                                                                                                                                                                                                    +
         '======================================================================%s' ||\r                                                                                                                                                                              +
         'BACKUP COMPLETO PREPARADO%s' ||\r                                                                                                                                                                                                                           +
         'Execute os comandos pg_dump listados acima para realizar os backups.%s' ||\r                                                                                                                                                                                +
         'Recomenda-se executar em paralelo para otimizar o tempo.%s',\r                                                                                                                                                                                              +
         E'\n',\r                                                                                                                                                                                                                                                     +
         E'\n',\r                                                                                                                                                                                                                                                     +
         E'\n',\r                                                                                                                                                                                                                                                     +
         E'\n'\r                                                                                                                                                                                                                                                      +
     );\r                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     RETURN result;\r                                                                                                                                                                                                                                                 +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.backup_schema(schema_name text, backup_path text DEFAULT '/tmp/backup'::text, include_data boolean DEFAULT true)                                                                                                                   +
  RETURNS text                                                                                                                                                                                                                                                        +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     backup_file TEXT;\r                                                                                                                                                                                                                                              +
     cmd TEXT;\r                                                                                                                                                                                                                                                      +
     result TEXT;\r                                                                                                                                                                                                                                                   +
     table_count INTEGER;\r                                                                                                                                                                                                                                           +
     view_count INTEGER;\r                                                                                                                                                                                                                                            +
     total_size_mb NUMERIC;\r                                                                                                                                                                                                                                         +
 BEGIN\r                                                                                                                                                                                                                                                              +
     -- Valida se o schema existe\r                                                                                                                                                                                                                                   +
     IF NOT EXISTS (SELECT 1 FROM pg_namespace WHERE nspname = schema_name) THEN\r                                                                                                                                                                                    +
         RETURN 'ERRO: Schema ' || schema_name || ' não existe';\r                                                                                                                                                                                                    +
     END IF;\r                                                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                   +
     -- Gera nome do arquivo de backup\r                                                                                                                                                                                                                              +
     backup_file := backup_path || '/backup_' || schema_name || '_' ||\r                                                                                                                                                                                              +
                    TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM-DD_HH24-MI-SS') || '.sql';\r                                                                                                                                                                                  +
 \r                                                                                                                                                                                                                                                                   +
     -- Conta objetos no schema\r                                                                                                                                                                                                                                     +
     SELECT\r                                                                                                                                                                                                                                                         +
         COUNT(CASE WHEN relkind IN ('r', 'm') THEN 1 END),\r                                                                                                                                                                                                         +
         COUNT(CASE WHEN relkind = 'v' THEN 1 END),\r                                                                                                                                                                                                                 +
         ROUND(SUM(pg_total_relation_size(c.oid)) / (1024.0 * 1024.0), 2)\r                                                                                                                                                                                           +
     INTO table_count, view_count, total_size_mb\r                                                                                                                                                                                                                    +
     FROM pg_class c\r                                                                                                                                                                                                                                                +
     JOIN pg_namespace n ON n.oid = c.relnamespace\r                                                                                                                                                                                                                  +
     WHERE n.nspname = schema_name;\r                                                                                                                                                                                                                                 +
 \r                                                                                                                                                                                                                                                                   +
     -- Prepara comando de backup\r                                                                                                                                                                                                                                   +
     IF include_data THEN\r                                                                                                                                                                                                                                           +
         cmd := format('pg_dump -h %s -p %s -U %s -d %s --schema=%s --verbose --file=%s',\r                                                                                                                                                                           +
                      '147.93.15.121', '5434', 'sienge_app', 'sienge_data', schema_name, backup_file);\r                                                                                                                                                              +
     ELSE\r                                                                                                                                                                                                                                                           +
         cmd := format('pg_dump -h %s -p %s -U %s -d %s --schema=%s --schema-only --verbose --file=%s',\r                                                                                                                                                             +
                      '147.93.15.121', '5434', 'sienge_app', 'sienge_data', schema_name, backup_file);\r                                                                                                                                                              +
     END IF;\r                                                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                   +
     -- Log início do backup\r                                                                                                                                                                                                                                        +
     RAISE NOTICE 'Iniciando backup do schema %', schema_name;\r                                                                                                                                                                                                      +
     RAISE NOTICE 'Objetos: % tabelas/views materializadas, % views, %.2f MB',\r                                                                                                                                                                                      +
                  table_count, view_count, total_size_mb;\r                                                                                                                                                                                                           +
     RAISE NOTICE 'Comando: %', cmd;\r                                                                                                                                                                                                                                +
 \r                                                                                                                                                                                                                                                                   +
     -- Registra no log de sistema\r                                                                                                                                                                                                                                  +
     BEGIN\r                                                                                                                                                                                                                                                          +
         INSERT INTO system.sync_logs (\r                                                                                                                                                                                                                             +
             "entityType",\r                                                                                                                                                                                                                                          +
             "syncStartedAt",\r                                                                                                                                                                                                                                       +
             "recordsProcessed",\r                                                                                                                                                                                                                                    +
             "status"\r                                                                                                                                                                                                                                               +
         ) VALUES (\r                                                                                                                                                                                                                                                 +
             'BACKUP_SCHEMA_' || schema_name,\r                                                                                                                                                                                                                       +
             CURRENT_TIMESTAMP,\r                                                                                                                                                                                                                                     +
             table_count + view_count,\r                                                                                                                                                                                                                              +
             'in_progress'\r                                                                                                                                                                                                                                          +
         );\r                                                                                                                                                                                                                                                         +
     EXCEPTION WHEN others THEN\r                                                                                                                                                                                                                                     +
         RAISE NOTICE 'Aviso: Não foi possível inserir log de backup';\r                                                                                                                                                                                              +
     END;\r                                                                                                                                                                                                                                                           +
 \r                                                                                                                                                                                                                                                                   +
     -- Monta resultado\r                                                                                                                                                                                                                                             +
     result := format(\r                                                                                                                                                                                                                                              +
         'Backup do schema %s preparado:%s' ||\r                                                                                                                                                                                                                      +
         'Arquivo: %s%s' ||\r                                                                                                                                                                                                                                         +
         'Objetos: %s tabelas/views mat, %s views%s' ||\r                                                                                                                                                                                                             +
         'Tamanho: %.2f MB%s' ||\r                                                                                                                                                                                                                                    +
         'Comando: %s%s%s' ||\r                                                                                                                                                                                                                                       +
         'IMPORTANTE: Execute o comando acima no terminal para realizar o backup.',\r                                                                                                                                                                                 +
         schema_name, E'\n',\r                                                                                                                                                                                                                                        +
         backup_file, E'\n',\r                                                                                                                                                                                                                                        +
         table_count, view_count, E'\n',\r                                                                                                                                                                                                                            +
         total_size_mb, E'\n',\r                                                                                                                                                                                                                                      +
         cmd, E'\n', E'\n'\r                                                                                                                                                                                                                                          +
     );\r                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     RETURN result;\r                                                                                                                                                                                                                                                 +
 \r                                                                                                                                                                                                                                                                   +
 EXCEPTION WHEN others THEN\r                                                                                                                                                                                                                                         +
     -- Log erro\r                                                                                                                                                                                                                                                    +
     BEGIN\r                                                                                                                                                                                                                                                          +
         UPDATE system.sync_logs\r                                                                                                                                                                                                                                    +
         SET status = 'error',\r                                                                                                                                                                                                                                      +
             "errorMessage" = SQLERRM,\r                                                                                                                                                                                                                              +
             "syncCompletedAt" = CURRENT_TIMESTAMP\r                                                                                                                                                                                                                  +
         WHERE "entityType" = 'BACKUP_SCHEMA_' || schema_name\r                                                                                                                                                                                                       +
         AND status = 'in_progress';\r                                                                                                                                                                                                                                +
     EXCEPTION WHEN others THEN\r                                                                                                                                                                                                                                     +
         NULL;\r                                                                                                                                                                                                                                                      +
     END;\r                                                                                                                                                                                                                                                           +
 \r                                                                                                                                                                                                                                                                   +
     RETURN 'ERRO: ' || SQLERRM;\r                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.check_materialized_views_status()                                                                                                                                                                                                  +
  RETURNS TABLE(schema_name text, view_name text, size_mb numeric, row_count bigint, last_refresh timestamp without time zone, is_populated boolean)                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 BEGIN\r                                                                                                                                                                                                                                                              +
     RETURN QUERY\r                                                                                                                                                                                                                                                   +
     SELECT\r                                                                                                                                                                                                                                                         +
         mv.schemaname::TEXT,\r                                                                                                                                                                                                                                       +
         mv.matviewname::TEXT,\r                                                                                                                                                                                                                                      +
         ROUND(pg_total_relation_size(mv.schemaname||'.'||mv.matviewname) / (1024.0 * 1024.0), 2) as size_mb,\r                                                                                                                                                       +
         CASE\r                                                                                                                                                                                                                                                       +
             WHEN mv.ispopulated THEN\r                                                                                                                                                                                                                               +
                 (SELECT count(*) FROM pg_stat_user_tables\r                                                                                                                                                                                                          +
                  WHERE schemaname = mv.schemaname AND relname = mv.matviewname)\r                                                                                                                                                                                    +
             ELSE 0\r                                                                                                                                                                                                                                                 +
         END as row_count,\r                                                                                                                                                                                                                                          +
         COALESCE(\r                                                                                                                                                                                                                                                  +
             (SELECT max("syncCompletedAt")\r                                                                                                                                                                                                                         +
              FROM system.sync_logs\r                                                                                                                                                                                                                                 +
              WHERE "entityType" = 'REFRESH_VIEW_' || mv.schemaname||'.'||mv.matviewname\r                                                                                                                                                                            +
              AND status = 'success'),\r                                                                                                                                                                                                                              +
             '1970-01-01'::timestamp\r                                                                                                                                                                                                                                +
         ) as last_refresh,\r                                                                                                                                                                                                                                         +
         mv.ispopulated\r                                                                                                                                                                                                                                             +
     FROM pg_matviews mv\r                                                                                                                                                                                                                                            +
     WHERE mv.schemaname IN ('silver', 'gold')\r                                                                                                                                                                                                                      +
     ORDER BY mv.schemaname, mv.matviewname;\r                                                                                                                                                                                                                        +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.check_performance_alerts()                                                                                                                                                                                                         +
  RETURNS TABLE(alert_level text, alert_type text, message text, action_required text)                                                                                                                                                                                +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     rec RECORD;\r                                                                                                                                                                                                                                                    +
 BEGIN\r                                                                                                                                                                                                                                                              +
     -- Verifica queries muito lentas (> 5 segundos)\r                                                                                                                                                                                                                +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT * FROM monitor_slow_queries(5.0)\r                                                                                                                                                                                                                    +
     LOOP\r                                                                                                                                                                                                                                                           +
         SELECT 'CRITICAL'::TEXT, 'SLOW_QUERY'::TEXT,\r                                                                                                                                                                                                               +
                'Query com média de ' || rec.avg_time_ms || 'ms detectada',\r                                                                                                                                                                                         +
                'Otimizar query: ' || LEFT(rec.query_text, 100)\r                                                                                                                                                                                                     +
         INTO alert_level, alert_type, message, action_required;\r                                                                                                                                                                                                    +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
     -- Verifica views não atualizadas há mais de 48h\r                                                                                                                                                                                                               +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT * FROM check_materialized_views_status()\r                                                                                                                                                                                                            +
         WHERE last_refresh < CURRENT_TIMESTAMP - INTERVAL '48 hours'\r                                                                                                                                                                                               +
     LOOP\r                                                                                                                                                                                                                                                           +
         SELECT 'WARNING'::TEXT, 'STALE_VIEW'::TEXT,\r                                                                                                                                                                                                                +
                'View ' || rec.schema_name || '.' || rec.view_name || ' não atualizada há ' ||\r                                                                                                                                                                      +
                EXTRACT(HOUR FROM (CURRENT_TIMESTAMP - rec.last_refresh)) || ' horas',\r                                                                                                                                                                              +
                'Executar refresh da view'\r                                                                                                                                                                                                                          +
         INTO alert_level, alert_type, message, action_required;\r                                                                                                                                                                                                    +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
     -- Verifica crescimento excessivo de dados\r                                                                                                                                                                                                                     +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT * FROM monitor_data_growth()\r                                                                                                                                                                                                                        +
         WHERE size_mb > 1000\r                                                                                                                                                                                                                                       +
     LOOP\r                                                                                                                                                                                                                                                           +
         SELECT 'INFO'::TEXT, 'LARGE_OBJECT'::TEXT,\r                                                                                                                                                                                                                 +
                rec.object_name || ' tem ' || rec.size_mb || 'MB',\r                                                                                                                                                                                                  +
                'Monitorar crescimento e considerar particionamento'\r                                                                                                                                                                                                +
         INTO alert_level, alert_type, message, action_required;\r                                                                                                                                                                                                    +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.datawarehouse_health_check()                                                                                                                                                                                                       +
  RETURNS TABLE(category text, component text, status text, value text, recommendation text)                                                                                                                                                                          +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     total_size_mb NUMERIC;\r                                                                                                                                                                                                                                         +
     view_count INTEGER;\r                                                                                                                                                                                                                                            +
     slow_query_count INTEGER;\r                                                                                                                                                                                                                                      +
     unused_index_count INTEGER;\r                                                                                                                                                                                                                                    +
 BEGIN\r                                                                                                                                                                                                                                                              +
     -- Verifica tamanho total do DW\r                                                                                                                                                                                                                                +
     SELECT SUM(pg_total_relation_size(c.oid) / (1024.0 * 1024.0))\r                                                                                                                                                                                                  +
     INTO total_size_mb\r                                                                                                                                                                                                                                             +
     FROM pg_class c\r                                                                                                                                                                                                                                                +
     JOIN pg_namespace n ON n.oid = c.relnamespace\r                                                                                                                                                                                                                  +
     WHERE n.nspname IN ('bronze', 'silver', 'gold');\r                                                                                                                                                                                                               +
 \r                                                                                                                                                                                                                                                                   +
     -- Conta views materializadas\r                                                                                                                                                                                                                                  +
     SELECT COUNT(*)\r                                                                                                                                                                                                                                                +
     INTO view_count\r                                                                                                                                                                                                                                                +
     FROM pg_matviews\r                                                                                                                                                                                                                                               +
     WHERE schemaname IN ('silver', 'gold');\r                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                   +
     -- Conta queries em execução (substituto para queries lentas)\r                                                                                                                                                                                                  +
     SELECT COUNT(*)\r                                                                                                                                                                                                                                                +
     INTO slow_query_count\r                                                                                                                                                                                                                                          +
     FROM pg_stat_activity\r                                                                                                                                                                                                                                          +
     WHERE state != 'idle'\r                                                                                                                                                                                                                                          +
         AND EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - query_start)) > 1;\r                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     -- Conta índices não utilizados\r                                                                                                                                                                                                                                +
     SELECT COUNT(*)\r                                                                                                                                                                                                                                                +
     INTO unused_index_count\r                                                                                                                                                                                                                                        +
     FROM pg_stat_user_indexes\r                                                                                                                                                                                                                                      +
     WHERE idx_scan = 0 AND schemaname IN ('bronze', 'silver', 'gold');\r                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     -- RETORNA RESULTADOS\r                                                                                                                                                                                                                                          +
 \r                                                                                                                                                                                                                                                                   +
     -- Tamanho total\r                                                                                                                                                                                                                                               +
     SELECT 'STORAGE'::TEXT, 'Total Size'::TEXT,\r                                                                                                                                                                                                                    +
            CASE WHEN total_size_mb < 1000 THEN 'GOOD'\r                                                                                                                                                                                                              +
                 WHEN total_size_mb < 5000 THEN 'WARNING'\r                                                                                                                                                                                                           +
                 ELSE 'CRITICAL' END,\r                                                                                                                                                                                                                               +
            total_size_mb::TEXT || ' MB',\r                                                                                                                                                                                                                           +
            CASE WHEN total_size_mb > 5000 THEN 'Considere archiving de dados antigos'\r                                                                                                                                                                              +
                 ELSE 'Tamanho adequado' END\r                                                                                                                                                                                                                        +
     INTO category, component, status, value, recommendation;\r                                                                                                                                                                                                       +
     RETURN NEXT;\r                                                                                                                                                                                                                                                   +
 \r                                                                                                                                                                                                                                                                   +
     -- Views materializadas\r                                                                                                                                                                                                                                        +
     SELECT 'VIEWS'::TEXT, 'Materialized Views'::TEXT,\r                                                                                                                                                                                                              +
            CASE WHEN view_count >= 4 THEN 'GOOD'\r                                                                                                                                                                                                                   +
                 WHEN view_count >= 2 THEN 'WARNING'\r                                                                                                                                                                                                                +
                 ELSE 'CRITICAL' END,\r                                                                                                                                                                                                                               +
            view_count::TEXT || ' views',\r                                                                                                                                                                                                                           +
            CASE WHEN view_count < 4 THEN 'Implementar views em falta'\r                                                                                                                                                                                              +
                 ELSE 'Estrutura completa' END\r                                                                                                                                                                                                                      +
     INTO category, component, status, value, recommendation;\r                                                                                                                                                                                                       +
     RETURN NEXT;\r                                                                                                                                                                                                                                                   +
 \r                                                                                                                                                                                                                                                                   +
     -- Performance\r                                                                                                                                                                                                                                                 +
     SELECT 'PERFORMANCE'::TEXT, 'Slow Queries'::TEXT,\r                                                                                                                                                                                                              +
            CASE WHEN slow_query_count = 0 THEN 'GOOD'\r                                                                                                                                                                                                              +
                 WHEN slow_query_count < 5 THEN 'WARNING'\r                                                                                                                                                                                                           +
                 ELSE 'CRITICAL' END,\r                                                                                                                                                                                                                               +
            slow_query_count::TEXT || ' queries > 1s',\r                                                                                                                                                                                                              +
            CASE WHEN slow_query_count > 5 THEN 'Otimizar queries lentas'\r                                                                                                                                                                                           +
                 WHEN slow_query_count > 0 THEN 'Monitorar performance'\r                                                                                                                                                                                             +
                 ELSE 'Performance adequada' END\r                                                                                                                                                                                                                    +
     INTO category, component, status, value, recommendation;\r                                                                                                                                                                                                       +
     RETURN NEXT;\r                                                                                                                                                                                                                                                   +
 \r                                                                                                                                                                                                                                                                   +
     -- Índices\r                                                                                                                                                                                                                                                     +
     SELECT 'INDEXES'::TEXT, 'Unused Indexes'::TEXT,\r                                                                                                                                                                                                                +
            CASE WHEN unused_index_count = 0 THEN 'GOOD'\r                                                                                                                                                                                                            +
                 WHEN unused_index_count < 3 THEN 'WARNING'\r                                                                                                                                                                                                         +
                 ELSE 'CRITICAL' END,\r                                                                                                                                                                                                                               +
            unused_index_count::TEXT || ' unused',\r                                                                                                                                                                                                                  +
            CASE WHEN unused_index_count > 3 THEN 'Remover índices não utilizados'\r                                                                                                                                                                                  +
                 WHEN unused_index_count > 0 THEN 'Avaliar necessidade dos índices'\r                                                                                                                                                                                 +
                 ELSE 'Índices bem utilizados' END\r                                                                                                                                                                                                                  +
     INTO category, component, status, value, recommendation;\r                                                                                                                                                                                                       +
     RETURN NEXT;\r                                                                                                                                                                                                                                                   +
 \r                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.generate_restore_script(schema_name text, backup_file text, drop_existing boolean DEFAULT false)                                                                                                                                   +
  RETURNS text                                                                                                                                                                                                                                                        +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     restore_script TEXT := '';\r                                                                                                                                                                                                                                     +
 BEGIN\r                                                                                                                                                                                                                                                              +
     restore_script := format(\r                                                                                                                                                                                                                                      +
         '-- ==================================================================%s' ||\r                                                                                                                                                                               +
         '-- SCRIPT DE RESTORE PARA SCHEMA: %s%s' ||\r                                                                                                                                                                                                                +
         '-- Arquivo de backup: %s%s' ||\r                                                                                                                                                                                                                            +
         '-- Gerado em: %s%s' ||\r                                                                                                                                                                                                                                    +
         '-- ==================================================================%s%s',\r                                                                                                                                                                               +
         E'\n', schema_name, E'\n',\r                                                                                                                                                                                                                                 +
         backup_file, E'\n',\r                                                                                                                                                                                                                                        +
         CURRENT_TIMESTAMP, E'\n',\r                                                                                                                                                                                                                                  +
         E'\n', E'\n'\r                                                                                                                                                                                                                                               +
     );\r                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     IF drop_existing THEN\r                                                                                                                                                                                                                                          +
         restore_script := restore_script || format(\r                                                                                                                                                                                                                +
             '-- ATENÇÃO: Este script irá REMOVER o schema existente!%s' ||\r                                                                                                                                                                                         +
             '-- Fazer backup antes de executar se necessário%s%s' ||\r                                                                                                                                                                                               +
             'DROP SCHEMA IF EXISTS %s CASCADE;%s%s',\r                                                                                                                                                                                                               +
             E'\n', E'\n', E'\n',\r                                                                                                                                                                                                                                   +
             schema_name, E'\n', E'\n'\r                                                                                                                                                                                                                              +
         );\r                                                                                                                                                                                                                                                         +
     END IF;\r                                                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                   +
     restore_script := restore_script || format(\r                                                                                                                                                                                                                    +
         '-- Comando de restore:%s' ||\r                                                                                                                                                                                                                              +
         'psql -h 147.93.15.121 -p 5434 -U sienge_app -d sienge_data -f %s%s%s' ||\r                                                                                                                                                                                  +
         '-- Ou usando pg_restore se for formato custom:%s' ||\r                                                                                                                                                                                                      +
         '-- pg_restore -h 147.93.15.121 -p 5434 -U sienge_app -d sienge_data %s%s%s' ||\r                                                                                                                                                                            +
         '-- Após o restore, execute:%s' ||\r                                                                                                                                                                                                                         +
         'SELECT ''Restore do schema %s completado em'' || CURRENT_TIMESTAMP;%s%s' ||\r                                                                                                                                                                               +
         '-- Verificar integridade:%s' ||\r                                                                                                                                                                                                                           +
         'SELECT check_materialized_views_status();%s%s' ||\r                                                                                                                                                                                                         +
         '-- Refresh das views materializadas se necessário:%s' ||\r                                                                                                                                                                                                  +
         'SELECT refresh_all_datawarehouse_views();%s',\r                                                                                                                                                                                                             +
         E'\n',\r                                                                                                                                                                                                                                                     +
         backup_file, E'\n', E'\n',\r                                                                                                                                                                                                                                 +
         E'\n',\r                                                                                                                                                                                                                                                     +
         backup_file, E'\n', E'\n',\r                                                                                                                                                                                                                                 +
         E'\n',\r                                                                                                                                                                                                                                                     +
         schema_name, E'\n', E'\n',\r                                                                                                                                                                                                                                 +
         E'\n',\r                                                                                                                                                                                                                                                     +
         E'\n', E'\n',\r                                                                                                                                                                                                                                              +
         E'\n',\r                                                                                                                                                                                                                                                     +
         E'\n'\r                                                                                                                                                                                                                                                      +
     );\r                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     RETURN restore_script;\r                                                                                                                                                                                                                                         +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.list_available_backups(backup_path text DEFAULT '/tmp/backup'::text)                                                                                                                                                               +
  RETURNS TABLE(backup_file text, schema_name text, backup_date timestamp without time zone, estimated_size text)                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 BEGIN\r                                                                                                                                                                                                                                                              +
     -- Esta função retorna informações dos backups baseado nos logs\r                                                                                                                                                                                                +
     -- Nota: Não consegue listar arquivos reais do sistema de arquivos\r                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     RETURN QUERY\r                                                                                                                                                                                                                                                   +
     SELECT\r                                                                                                                                                                                                                                                         +
         'backup_' || REPLACE("entityType", 'BACKUP_SCHEMA_', '') || '_' ||\r                                                                                                                                                                                         +
         TO_CHAR("syncStartedAt", 'YYYY-MM-DD_HH24-MI-SS') || '.sql' as backup_file,\r                                                                                                                                                                                +
         REPLACE("entityType", 'BACKUP_SCHEMA_', '') as schema_name,\r                                                                                                                                                                                                +
         "syncStartedAt" as backup_date,\r                                                                                                                                                                                                                            +
         "recordsProcessed"::TEXT || ' objetos' as estimated_size\r                                                                                                                                                                                                   +
     FROM system.sync_logs\r                                                                                                                                                                                                                                          +
     WHERE "entityType" LIKE 'BACKUP_SCHEMA_%'\r                                                                                                                                                                                                                      +
         AND status = 'success'\r                                                                                                                                                                                                                                     +
     ORDER BY "syncStartedAt" DESC;\r                                                                                                                                                                                                                                 +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.monitor_data_growth()                                                                                                                                                                                                              +
  RETURNS TABLE(schema_name text, object_name text, object_type text, size_mb numeric, estimated_rows bigint, avg_row_size_bytes integer, last_vacuum timestamp without time zone, last_analyze timestamp without time zone, bloat_ratio numeric, recommendation text)+
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 BEGIN\r                                                                                                                                                                                                                                                              +
     RETURN QUERY\r                                                                                                                                                                                                                                                   +
     SELECT\r                                                                                                                                                                                                                                                         +
         n.nspname::TEXT as schema_name,\r                                                                                                                                                                                                                            +
         c.relname::TEXT as object_name,\r                                                                                                                                                                                                                            +
         CASE c.relkind\r                                                                                                                                                                                                                                             +
             WHEN 'r' THEN 'TABLE'\r                                                                                                                                                                                                                                  +
             WHEN 'm' THEN 'MATERIALIZED_VIEW'\r                                                                                                                                                                                                                      +
             WHEN 'v' THEN 'VIEW'\r                                                                                                                                                                                                                                   +
         END as object_type,\r                                                                                                                                                                                                                                        +
         ROUND(pg_total_relation_size(c.oid) / (1024.0 * 1024.0), 2) as size_mb,\r                                                                                                                                                                                    +
         s.n_tup_ins + s.n_tup_upd + s.n_tup_del as estimated_rows,\r                                                                                                                                                                                                 +
         CASE\r                                                                                                                                                                                                                                                       +
             WHEN s.n_tup_ins + s.n_tup_upd + s.n_tup_del > 0\r                                                                                                                                                                                                       +
             THEN (pg_total_relation_size(c.oid) / (s.n_tup_ins + s.n_tup_upd + s.n_tup_del))::INTEGER\r                                                                                                                                                              +
             ELSE 0\r                                                                                                                                                                                                                                                 +
         END as avg_row_size_bytes,\r                                                                                                                                                                                                                                 +
         s.last_vacuum,\r                                                                                                                                                                                                                                             +
         s.last_analyze,\r                                                                                                                                                                                                                                            +
         CASE\r                                                                                                                                                                                                                                                       +
             WHEN s.n_tup_ins + s.n_tup_upd + s.n_tup_del > 0\r                                                                                                                                                                                                       +
             THEN ROUND((s.n_dead_tup::NUMERIC / (s.n_tup_ins + s.n_tup_upd + s.n_tup_del)::NUMERIC) * 100, 2)\r                                                                                                                                                      +
             ELSE 0\r                                                                                                                                                                                                                                                 +
         END as bloat_ratio,\r                                                                                                                                                                                                                                        +
         CASE\r                                                                                                                                                                                                                                                       +
             WHEN s.last_analyze < CURRENT_TIMESTAMP - INTERVAL '7 days' THEN 'PRECISA ANALYZE'\r                                                                                                                                                                     +
             WHEN s.last_vacuum < CURRENT_TIMESTAMP - INTERVAL '7 days' THEN 'PRECISA VACUUM'\r                                                                                                                                                                       +
             WHEN (s.n_dead_tup::NUMERIC / NULLIF(s.n_tup_ins + s.n_tup_upd + s.n_tup_del, 0)::NUMERIC) > 0.1 THEN 'ALTO BLOAT'\r                                                                                                                                     +
             ELSE 'OK'\r                                                                                                                                                                                                                                              +
         END as recommendation\r                                                                                                                                                                                                                                      +
     FROM pg_class c\r                                                                                                                                                                                                                                                +
     JOIN pg_namespace n ON n.oid = c.relnamespace\r                                                                                                                                                                                                                  +
     LEFT JOIN pg_stat_user_tables s ON s.relid = c.oid\r                                                                                                                                                                                                             +
     WHERE n.nspname IN ('bronze', 'silver', 'gold', 'system')\r                                                                                                                                                                                                      +
         AND c.relkind IN ('r', 'm')\r                                                                                                                                                                                                                                +
     ORDER BY size_mb DESC;\r                                                                                                                                                                                                                                         +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.monitor_slow_queries(min_duration_seconds numeric DEFAULT 1.0)                                                                                                                                                                     +
  RETURNS TABLE(query_text text, state text, duration_seconds numeric, rows_affected bigint, client_info text)                                                                                                                                                        +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 BEGIN\r                                                                                                                                                                                                                                                              +
     -- Versão alternativa usando pg_stat_activity para queries em execução\r                                                                                                                                                                                         +
     RETURN QUERY\r                                                                                                                                                                                                                                                   +
     SELECT\r                                                                                                                                                                                                                                                         +
         LEFT(a.query, 200) as query_text,\r                                                                                                                                                                                                                          +
         a.state,\r                                                                                                                                                                                                                                                   +
         EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - a.query_start)) as duration_seconds,\r                                                                                                                                                                               +
         0::BIGINT as rows_affected, -- Não disponível sem pg_stat_statements\r                                                                                                                                                                                       +
         a.application_name || ' (' || a.client_addr || ')' as client_info\r                                                                                                                                                                                          +
     FROM pg_stat_activity a\r                                                                                                                                                                                                                                        +
     WHERE a.state != 'idle'\r                                                                                                                                                                                                                                        +
         AND a.query IS NOT NULL\r                                                                                                                                                                                                                                    +
         AND a.query NOT LIKE '%pg_stat_%'\r                                                                                                                                                                                                                          +
         AND a.query NOT LIKE '%monitor_%'\r                                                                                                                                                                                                                          +
         AND EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - a.query_start)) >= min_duration_seconds\r                                                                                                                                                                        +
     ORDER BY duration_seconds DESC;\r                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.refresh_all_datawarehouse_views()                                                                                                                                                                                                  +
  RETURNS TABLE(view_name text, result text)                                                                                                                                                                                                                          +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                        +
 DECLARE                                                                                                                                                                                                                                                              +
     view_record RECORD;                                                                                                                                                                                                                                              +
     start_time TIMESTAMP;                                                                                                                                                                                                                                            +
     end_time TIMESTAMP;                                                                                                                                                                                                                                              +
     total_duration INTERVAL;                                                                                                                                                                                                                                         +
 BEGIN                                                                                                                                                                                                                                                                +
     start_time := clock_timestamp();                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                      +
     RAISE NOTICE '=== Iniciando refresh completo do Data Warehouse ===';                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                      +
     -- Refresh em ordem de dependência:                                                                                                                                                                                                                              +
     -- 1. SILVER (core)                                                                                                                                                                                                                                              +
     -- 2. SILVER (outras views)                                                                                                                                                                                                                                      +
     -- 3. GOLD (views especializadas)                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                      +
     -- FASE 1: Views SILVER                                                                                                                                                                                                                                          +
     RAISE NOTICE 'FASE 1: Atualizando views SILVER...';                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                      +
     SELECT 'silver.rpt_sienge_core' as name, refresh_materialized_view('silver', 'rpt_sienge_core') as result                                                                                                                                                        +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'silver.rpt_sienge_financeiro' as name, refresh_materialized_view('silver', 'rpt_sienge_financeiro') as result                                                                                                                                            +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'silver.rpt_sienge_clientes' as name, refresh_materialized_view('silver', 'rpt_sienge_clientes') as result                                                                                                                                                +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'silver.rpt_sienge_contratos' as name, refresh_materialized_view('silver', 'rpt_sienge_contratos') as result                                                                                                                                              +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'silver.rpt_sienge_empreendimentos' as name, refresh_materialized_view('silver', 'rpt_sienge_empreendimentos') as result                                                                                                                                  +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'silver.rpt_sienge_unidades' as name, refresh_materialized_view('silver', 'rpt_sienge_unidades') as result                                                                                                                                                +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     -- FASE 2: Views GOLD (dependem das SILVER)                                                                                                                                                                                                                      +
     RAISE NOTICE 'FASE 2: Atualizando views GOLD...';                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                      +
     SELECT 'gold.vendas_360' as name, refresh_materialized_view('gold', 'vendas_360') as result                                                                                                                                                                      +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'gold.clientes_360' as name, refresh_materialized_view('gold', 'clientes_360') as result                                                                                                                                                                  +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'gold.portfolio_imobiliario' as name, refresh_materialized_view('gold', 'portfolio_imobiliario') as result                                                                                                                                                +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     SELECT 'gold.performance_financeira' as name, refresh_materialized_view('gold', 'performance_financeira') as result                                                                                                                                              +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
     -- Calcula duração total                                                                                                                                                                                                                                         +
     end_time := clock_timestamp();                                                                                                                                                                                                                                   +
     total_duration := end_time - start_time;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                      +
     RAISE NOTICE '=== Refresh completo finalizado em % ===', total_duration;                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                      +
     -- Retorna resumo final                                                                                                                                                                                                                                          +
     SELECT 'RESUMO_FINAL' as name,                                                                                                                                                                                                                                   +
            format('Refresh completo executado em %s', total_duration) as result                                                                                                                                                                                      +
     INTO view_name, result;                                                                                                                                                                                                                                          +
     RETURN NEXT;                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                      +
 END;                                                                                                                                                                                                                                                                 +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.refresh_materialized_view(schema_name text, view_name text)                                                                                                                                                                        +
  RETURNS text                                                                                                                                                                                                                                                        +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     start_time TIMESTAMP;\r                                                                                                                                                                                                                                          +
     end_time TIMESTAMP;\r                                                                                                                                                                                                                                            +
     duration INTERVAL;\r                                                                                                                                                                                                                                             +
     rows_affected BIGINT;\r                                                                                                                                                                                                                                          +
     result_message TEXT;\r                                                                                                                                                                                                                                           +
     full_view_name TEXT;\r                                                                                                                                                                                                                                           +
 BEGIN\r                                                                                                                                                                                                                                                              +
     start_time := clock_timestamp();\r                                                                                                                                                                                                                               +
     full_view_name := schema_name || '.' || view_name;\r                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     -- Log início do refresh\r                                                                                                                                                                                                                                       +
     RAISE NOTICE 'Iniciando refresh da view: %', full_view_name;\r                                                                                                                                                                                                   +
 \r                                                                                                                                                                                                                                                                   +
     -- Tenta refresh concorrente primeiro, depois normal se falhar\r                                                                                                                                                                                                 +
     BEGIN\r                                                                                                                                                                                                                                                          +
         EXECUTE format('REFRESH MATERIALIZED VIEW CONCURRENTLY %I.%I', schema_name, view_name);\r                                                                                                                                                                    +
         RAISE NOTICE 'Refresh CONCORRENTE executado com sucesso para %', full_view_name;\r                                                                                                                                                                           +
     EXCEPTION WHEN others THEN\r                                                                                                                                                                                                                                     +
         RAISE NOTICE 'Refresh concorrente falhou, tentando refresh normal para %', full_view_name;\r                                                                                                                                                                 +
         EXECUTE format('REFRESH MATERIALIZED VIEW %I.%I', schema_name, view_name);\r                                                                                                                                                                                 +
         RAISE NOTICE 'Refresh NORMAL executado com sucesso para %', full_view_name;\r                                                                                                                                                                                +
     END;\r                                                                                                                                                                                                                                                           +
 \r                                                                                                                                                                                                                                                                   +
     -- Calcula métricas\r                                                                                                                                                                                                                                            +
     end_time := clock_timestamp();\r                                                                                                                                                                                                                                 +
     duration := end_time - start_time;\r                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     -- Conta registros na view\r                                                                                                                                                                                                                                     +
     EXECUTE format('SELECT count(*) FROM %I.%I', schema_name, view_name) INTO rows_affected;\r                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                   +
     result_message := format(\r                                                                                                                                                                                                                                      +
         'View %s atualizada com sucesso. Duração: %s, Registros: %s',\r                                                                                                                                                                                              +
         full_view_name,\r                                                                                                                                                                                                                                            +
         duration,\r                                                                                                                                                                                                                                                  +
         rows_affected\r                                                                                                                                                                                                                                              +
     );\r                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     -- Log resultado\r                                                                                                                                                                                                                                               +
     RAISE NOTICE '%', result_message;\r                                                                                                                                                                                                                              +
 \r                                                                                                                                                                                                                                                                   +
     -- Insere log na tabela de sistema (se existir)\r                                                                                                                                                                                                                +
     BEGIN\r                                                                                                                                                                                                                                                          +
         INSERT INTO system.sync_logs (\r                                                                                                                                                                                                                             +
             "entityType",\r                                                                                                                                                                                                                                          +
             "syncStartedAt",\r                                                                                                                                                                                                                                       +
             "syncCompletedAt",\r                                                                                                                                                                                                                                     +
             "recordsProcessed",\r                                                                                                                                                                                                                                    +
             "status"\r                                                                                                                                                                                                                                               +
         ) VALUES (\r                                                                                                                                                                                                                                                 +
             'REFRESH_VIEW_' || full_view_name,\r                                                                                                                                                                                                                     +
             start_time,\r                                                                                                                                                                                                                                            +
             end_time,\r                                                                                                                                                                                                                                              +
             rows_affected::INTEGER,\r                                                                                                                                                                                                                                +
             'success'\r                                                                                                                                                                                                                                              +
         );\r                                                                                                                                                                                                                                                         +
     EXCEPTION WHEN others THEN\r                                                                                                                                                                                                                                     +
         RAISE NOTICE 'Aviso: Não foi possível inserir log em system.sync_logs';\r                                                                                                                                                                                    +
     END;\r                                                                                                                                                                                                                                                           +
 \r                                                                                                                                                                                                                                                                   +
     RETURN result_message;\r                                                                                                                                                                                                                                         +
 \r                                                                                                                                                                                                                                                                   +
 EXCEPTION WHEN others THEN\r                                                                                                                                                                                                                                         +
     end_time := clock_timestamp();\r                                                                                                                                                                                                                                 +
     duration := end_time - start_time;\r                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     result_message := format(\r                                                                                                                                                                                                                                      +
         'Erro ao atualizar view %s: %s (Duração: %s)',\r                                                                                                                                                                                                             +
         full_view_name,\r                                                                                                                                                                                                                                            +
         SQLERRM,\r                                                                                                                                                                                                                                                   +
         duration\r                                                                                                                                                                                                                                                   +
     );\r                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     -- Log erro\r                                                                                                                                                                                                                                                    +
     RAISE NOTICE '%', result_message;\r                                                                                                                                                                                                                              +
 \r                                                                                                                                                                                                                                                                   +
     -- Insere log de erro (se possível)\r                                                                                                                                                                                                                            +
     BEGIN\r                                                                                                                                                                                                                                                          +
         INSERT INTO system.sync_logs (\r                                                                                                                                                                                                                             +
             "entityType",\r                                                                                                                                                                                                                                          +
             "syncStartedAt",\r                                                                                                                                                                                                                                       +
             "syncCompletedAt",\r                                                                                                                                                                                                                                     +
             "recordsProcessed",\r                                                                                                                                                                                                                                    +
             "status",\r                                                                                                                                                                                                                                              +
             "errorMessage"\r                                                                                                                                                                                                                                         +
         ) VALUES (\r                                                                                                                                                                                                                                                 +
             'REFRESH_VIEW_' || full_view_name,\r                                                                                                                                                                                                                     +
             start_time,\r                                                                                                                                                                                                                                            +
             end_time,\r                                                                                                                                                                                                                                              +
             0,\r                                                                                                                                                                                                                                                     +
             'error',\r                                                                                                                                                                                                                                               +
             SQLERRM\r                                                                                                                                                                                                                                                +
         );\r                                                                                                                                                                                                                                                         +
     EXCEPTION WHEN others THEN\r                                                                                                                                                                                                                                     +
         -- Ignora erro de log\r                                                                                                                                                                                                                                      +
         NULL;\r                                                                                                                                                                                                                                                      +
     END;\r                                                                                                                                                                                                                                                           +
 \r                                                                                                                                                                                                                                                                   +
     RETURN result_message;\r                                                                                                                                                                                                                                         +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.smart_refresh_views(max_age_hours integer DEFAULT 24)                                                                                                                                                                              +
  RETURNS TABLE(view_name text, action text, reason text)                                                                                                                                                                                                             +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     view_record RECORD;\r                                                                                                                                                                                                                                            +
     needs_refresh BOOLEAN;\r                                                                                                                                                                                                                                         +
     age_hours NUMERIC;\r                                                                                                                                                                                                                                             +
 BEGIN\r                                                                                                                                                                                                                                                              +
     RAISE NOTICE 'Verificando quais views precisam de refresh (max age: % horas)', max_age_hours;\r                                                                                                                                                                  +
 \r                                                                                                                                                                                                                                                                   +
     FOR view_record IN\r                                                                                                                                                                                                                                             +
         SELECT * FROM check_materialized_views_status()\r                                                                                                                                                                                                            +
     LOOP\r                                                                                                                                                                                                                                                           +
         needs_refresh := FALSE;\r                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                   +
         -- Calcula idade em horas\r                                                                                                                                                                                                                                  +
         age_hours := EXTRACT(EPOCH FROM (now() - view_record.last_refresh)) / 3600.0;\r                                                                                                                                                                              +
 \r                                                                                                                                                                                                                                                                   +
         -- Verifica condições para refresh\r                                                                                                                                                                                                                         +
         IF NOT view_record.is_populated THEN\r                                                                                                                                                                                                                       +
             needs_refresh := TRUE;\r                                                                                                                                                                                                                                 +
             SELECT view_record.schema_name||'.'||view_record.view_name as name,\r                                                                                                                                                                                    +
                    'REFRESH' as act,\r                                                                                                                                                                                                                               +
                    'View não está populada' as reas\r                                                                                                                                                                                                                +
             INTO view_name, action, reason;\r                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                   +
         ELSIF age_hours > max_age_hours THEN\r                                                                                                                                                                                                                       +
             needs_refresh := TRUE;\r                                                                                                                                                                                                                                 +
             SELECT view_record.schema_name||'.'||view_record.view_name as name,\r                                                                                                                                                                                    +
                    'REFRESH' as act,\r                                                                                                                                                                                                                               +
                    format('View com %s horas (limite: %s)', ROUND(age_hours, 1), max_age_hours) as reas\r                                                                                                                                                            +
             INTO view_name, action, reason;\r                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                   +
         ELSE\r                                                                                                                                                                                                                                                       +
             SELECT view_record.schema_name||'.'||view_record.view_name as name,\r                                                                                                                                                                                    +
                    'SKIP' as act,\r                                                                                                                                                                                                                                  +
                    format('View atualizada há %s horas', ROUND(age_hours, 1)) as reas\r                                                                                                                                                                              +
             INTO view_name, action, reason;\r                                                                                                                                                                                                                        +
         END IF;\r                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                   +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
 \r                                                                                                                                                                                                                                                                   +
         -- Executa refresh se necessário\r                                                                                                                                                                                                                           +
         IF needs_refresh THEN\r                                                                                                                                                                                                                                      +
             PERFORM refresh_materialized_view(view_record.schema_name, view_record.view_name);\r                                                                                                                                                                     +
         END IF;\r                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                   +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.verify_restore_integrity()                                                                                                                                                                                                         +
  RETURNS TABLE(check_type text, schema_name text, object_name text, status text, details text)                                                                                                                                                                       +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     rec RECORD;\r                                                                                                                                                                                                                                                    +
     row_count BIGINT;\r                                                                                                                                                                                                                                              +
 BEGIN\r                                                                                                                                                                                                                                                              +
     -- Verifica se todos os schemas existem\r                                                                                                                                                                                                                        +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT unnest(ARRAY['bronze', 'silver', 'gold', 'system', 'staging']) as schema\r                                                                                                                                                                            +
     LOOP\r                                                                                                                                                                                                                                                           +
         IF EXISTS (SELECT 1 FROM pg_namespace WHERE nspname = rec.schema) THEN\r                                                                                                                                                                                     +
             SELECT 'SCHEMA_EXISTS', rec.schema, '', 'OK', 'Schema presente'\r                                                                                                                                                                                        +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         ELSE\r                                                                                                                                                                                                                                                       +
             SELECT 'SCHEMA_EXISTS', rec.schema, '', 'ERROR', 'Schema ausente'\r                                                                                                                                                                                      +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         END IF;\r                                                                                                                                                                                                                                                    +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
     -- Verifica views materializadas\r                                                                                                                                                                                                                               +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT schemaname, matviewname, ispopulated\r                                                                                                                                                                                                                +
         FROM pg_matviews\r                                                                                                                                                                                                                                           +
         WHERE schemaname IN ('silver', 'gold')\r                                                                                                                                                                                                                     +
     LOOP\r                                                                                                                                                                                                                                                           +
         IF rec.ispopulated THEN\r                                                                                                                                                                                                                                    +
             SELECT 'MATVIEW_STATUS', rec.schemaname, rec.matviewname, 'OK', 'View populada'\r                                                                                                                                                                        +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         ELSE\r                                                                                                                                                                                                                                                       +
             SELECT 'MATVIEW_STATUS', rec.schemaname, rec.matviewname, 'WARNING', 'View não populada'\r                                                                                                                                                               +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         END IF;\r                                                                                                                                                                                                                                                    +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
     -- Verifica contagem de registros nas tabelas principais\r                                                                                                                                                                                                       +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT schemaname, tablename\r                                                                                                                                                                                                                               +
         FROM pg_tables\r                                                                                                                                                                                                                                             +
         WHERE schemaname = 'bronze'\r                                                                                                                                                                                                                                +
         AND tablename IN ('clientes', 'contratos_venda', 'unidades', 'empreendimentos')\r                                                                                                                                                                            +
     LOOP\r                                                                                                                                                                                                                                                           +
         EXECUTE format('SELECT count(*) FROM %I.%I', rec.schemaname, rec.tablename) INTO row_count;\r                                                                                                                                                                +
 \r                                                                                                                                                                                                                                                                   +
         IF row_count > 0 THEN\r                                                                                                                                                                                                                                      +
             SELECT 'TABLE_DATA', rec.schemaname, rec.tablename, 'OK', row_count::TEXT || ' registros'\r                                                                                                                                                              +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         ELSE\r                                                                                                                                                                                                                                                       +
             SELECT 'TABLE_DATA', rec.schemaname, rec.tablename, 'WARNING', 'Tabela vazia'\r                                                                                                                                                                          +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         END IF;\r                                                                                                                                                                                                                                                    +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
     -- Verifica functions essenciais\r                                                                                                                                                                                                                               +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT 'refresh_materialized_view' as func_name\r                                                                                                                                                                                                            +
         UNION SELECT 'datawarehouse_health_check'\r                                                                                                                                                                                                                  +
         UNION SELECT 'check_materialized_views_status'\r                                                                                                                                                                                                             +
     LOOP\r                                                                                                                                                                                                                                                           +
         IF EXISTS (SELECT 1 FROM pg_proc WHERE proname = rec.func_name) THEN\r                                                                                                                                                                                       +
             SELECT 'FUNCTION_EXISTS', 'public', rec.func_name, 'OK', 'Function disponível'\r                                                                                                                                                                         +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         ELSE\r                                                                                                                                                                                                                                                       +
             SELECT 'FUNCTION_EXISTS', 'public', rec.func_name, 'ERROR', 'Function ausente'\r                                                                                                                                                                         +
             INTO check_type, schema_name, object_name, status, details;\r                                                                                                                                                                                            +
         END IF;\r                                                                                                                                                                                                                                                    +
         RETURN NEXT;\r                                                                                                                                                                                                                                               +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
 CREATE OR REPLACE FUNCTION bronze.weekly_performance_report()                                                                                                                                                                                                        +
  RETURNS text                                                                                                                                                                                                                                                        +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                      +
 DECLARE\r                                                                                                                                                                                                                                                            +
     report TEXT := '';\r                                                                                                                                                                                                                                             +
     rec RECORD;\r                                                                                                                                                                                                                                                    +
     total_views INTEGER;\r                                                                                                                                                                                                                                           +
     avg_size_mb NUMERIC;\r                                                                                                                                                                                                                                           +
     total_refreshes INTEGER;\r                                                                                                                                                                                                                                       +
 BEGIN\r                                                                                                                                                                                                                                                              +
     report := E'=== RELATÓRIO SEMANAL DE PERFORMANCE ===\n';\r                                                                                                                                                                                                       +
     report := report || 'Data: ' || CURRENT_TIMESTAMP || E'\n\n';\r                                                                                                                                                                                                  +
 \r                                                                                                                                                                                                                                                                   +
     -- Estatísticas gerais\r                                                                                                                                                                                                                                         +
     SELECT COUNT(*), AVG(size_mb)\r                                                                                                                                                                                                                                  +
     INTO total_views, avg_size_mb\r                                                                                                                                                                                                                                  +
     FROM check_materialized_views_status();\r                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                   +
     SELECT COUNT(*)\r                                                                                                                                                                                                                                                +
     INTO total_refreshes\r                                                                                                                                                                                                                                           +
     FROM system.sync_logs\r                                                                                                                                                                                                                                          +
     WHERE "entityType" LIKE 'REFRESH_VIEW_%'\r                                                                                                                                                                                                                       +
         AND "syncStartedAt" >= CURRENT_TIMESTAMP - INTERVAL '7 days';\r                                                                                                                                                                                              +
 \r                                                                                                                                                                                                                                                                   +
     report := report || 'ESTATÍSTICAS GERAIS:' || E'\n';\r                                                                                                                                                                                                           +
     report := report || '- Views Materializadas: ' || total_views || E'\n';\r                                                                                                                                                                                        +
     report := report || '- Tamanho Médio: ' || ROUND(avg_size_mb, 2) || ' MB' || E'\n';\r                                                                                                                                                                            +
     report := report || '- Refreshes na Semana: ' || total_refreshes || E'\n\n';\r                                                                                                                                                                                   +
 \r                                                                                                                                                                                                                                                                   +
     -- Health Check\r                                                                                                                                                                                                                                                +
     report := report || 'HEALTH CHECK:' || E'\n';\r                                                                                                                                                                                                                  +
     FOR rec IN SELECT * FROM datawarehouse_health_check() LOOP\r                                                                                                                                                                                                     +
         report := report || '- ' || rec.component || ': ' || rec.status || ' (' || rec.value || ')' || E'\n';\r                                                                                                                                                      +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
     report := report || E'\n';\r                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                   +
     -- Top queries lentas\r                                                                                                                                                                                                                                          +
     report := report || 'TOP 5 QUERIES LENTAS:' || E'\n';\r                                                                                                                                                                                                          +
     FOR rec IN\r                                                                                                                                                                                                                                                     +
         SELECT * FROM monitor_slow_queries(0.5) LIMIT 5\r                                                                                                                                                                                                            +
     LOOP\r                                                                                                                                                                                                                                                           +
         report := report || '- ' || ROUND(rec.avg_time_ms, 2) || 'ms: ' || LEFT(rec.query_text, 80) || E'\n';\r                                                                                                                                                      +
     END LOOP;\r                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                   +
     report := report || E'\n=== FIM DO RELATÓRIO ===';\r                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                   +
     RETURN report;\r                                                                                                                                                                                                                                                 +
 END;\r                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                           +
 ;                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                      +
 
(15 rows)



-- ===================================================================
-- CONCLUSÃO
-- ===================================================================

-- Log de conclusão
DO $$
BEGIN
    RAISE NOTICE 'Todas as funções customizadas foram criadas em %', now();
    RAISE NOTICE 'Total de 15 funções no schema bronze criadas com sucesso';
END $$;
